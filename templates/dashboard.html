{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Dashboard</h1>
</div>

<div class="row mb-4">
    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Total Inventory Items</h5>
                <p class="card-text display-4" id="inventory-count">{{ inventory_count }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Total Orders</h5>
                <p class="card-text display-4" id="order-count">{{ orders|length }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Total Sales</h5>
                <p class="card-text display-4" id="total-sales">${{ "%.2f"|format(total_sales) }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Last Update</h5>
                <p class="card-text" id="last-update">Just now</p>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Low Stock Products</h5>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Current Stock</th>
                            <th>Category</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="low-stock-table">
                        {% for product in low_stock_products %}
                        <tr>
                            <td>{{ product.name }}</td>
                            <td>{{ product.quantity }}</td>
                            <td>{{ product.category }}</td>
                            <td>
                                <button class="btn btn-sm btn-primary edit-product" data-id="{{ product.id }}">Edit</button>
                                <button class="btn btn-sm btn-danger delete-product" data-id="{{ product.id }}">Delete</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4 mb-3">
        <a href="{{ url_for('inventory_page') }}" class="btn btn-primary btn-lg btn-block w-100">
            <i data-lucide="plus-circle"></i> Add New Item
        </a>
    </div>
    <div class="col-md-4 mb-3">
        <a href="{{ url_for('download_report') }}" class="btn btn-secondary btn-lg btn-block w-100" id="downloadReport">
            <i data-lucide="download"></i> Download Report
        </a>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProductModalLabel">Edit Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editProductForm">
                    <input type="hidden" id="editProductId" name="id">
                    <div class="mb-3">
                        <label for="editProductName" class="form-label">Product Name</label>
                        <input type="text" class="form-control" id="editProductName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editProductQuantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="editProductQuantity" name="quantity" required>
                    </div>
                    <div class="mb-3">
                        <label for="editProductCategory" class="form-label">Category</label>
                        <input type="text" class="form-control" id="editProductCategory" name="category" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Real-time updates
    const eventSource = new EventSource("{{ url_for('stream') }}");
    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.event === 'update') {
            document.getElementById('inventory-count').textContent = data.inventory_count;
            document.getElementById('order-count').textContent = data.order_count;
            document.getElementById('total-sales').textContent = '$' + data.total_sales.toFixed(2);
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();

            // Update low stock products table
            const lowStockTable = document.getElementById('low-stock-table');
            lowStockTable.innerHTML = '';
            data.low_stock_products.forEach(product => {
                const row = `
                    <tr>
                        <td>${product.name}</td>
                        <td>${product.quantity}</td>
                        <td>${product.category}</td>
                        <td>
                            <button class="btn btn-sm btn-primary edit-product" data-id="${product.id}">Edit</button>
                            <button class="btn btn-sm btn-danger delete-product" data-id="${product.id}">Delete</button>
                        </td>
                    </tr>
                `;
                lowStockTable.innerHTML += row;
            });
        }
    };

    // Edit Product
    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('edit-product')) {
            const productId = e.target.getAttribute('data-id');
            fetch(`/get_product/${productId}`)
                .then(response => response.json())
                .then(product => {
                    document.getElementById('editProductId').value = product.id;
                    document.getElementById('editProductName').value = product.name;
                    document.getElementById('editProductQuantity').value = product.quantity;
                    document.getElementById('editProductCategory').value = product.category;
                    new bootstrap.Modal(document.getElementById('editProductModal')).show();
                });
        }
    });

    document.getElementById('editProductForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch('/edit_product', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        });
    });

    // Delete Product
    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('delete-product')) {
            if (confirm('Are you sure you want to delete this product?')) {
                const productId = e.target.getAttribute('data-id');
                fetch(`/delete_product/${productId}`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    });
            }
        }
    });
</script>
{% endblock %}

